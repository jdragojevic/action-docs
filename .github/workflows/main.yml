name: Build and Deploy
on:   
  push:
    branches:
      - main
  schedule:
    - cron: '0 1 * * *'
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Check     
    steps:
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
        env: 
          SQLCIPHER_LIB_DIR: ${{ github.workspace }}/libs/desktop/linux-x86-64/sqlcipher/lib
          SQLCIPHER_INCLUDE_DIR: ${{ github.workspace }}/libs/desktop/linux-x86-64/sqlcipher/include
          NSS_DIR: ${{ github.workspace }}/libs/desktop/linux-x86-64/nss
          NSS_STATIC: 1 
      - name: Get a-s repository
        run: |
          git init .
          git remote add origin https://github.com/mozilla/application-services.git
          git pull origin SYNC-2121-steal-this-book
          git submodule init
          git submodule update --recursive
          

      # - name: Install mdbook dependencies
      #   run: cargo install mdbook mdbook-mermaid mdbook-open-on-gh   
      
      # - name: Create Developer Docs
      #   run: |
      #     ./tools/build-book.sh
 
      - name: Build Dependencies and Generate Rust Docs
        run: |

          echo `env`
          # export SQLCIPHER_LIB_DIR=/home/runner/work/action-docs/action-docs/libs/desktop/linux-x86-64/sqlcipher/lib
          # export SQLCIPHER_INCLUDE_DIR=/home/runner/work/action-docs/action-docs/libs/desktop/linux-x86-64/sqlcipher/include
          # export NSS_DIR=/home/runner/work/action-docs/action-docs/libs/desktop/linux-x86-64/nss
          # export NSS_STATIC=1

          git clone https://chromium.googlesource.com/external/gyp.git tools/gyp
          cd tools/gyp
          sudo python setup.py install
          cd ../..
          sudo apt-get install ninja-build zlib1g-dev tclsh python3.6
          ./libs/verify-desktop-environment.sh
          cargo doc --no-deps --document-private-items
          echo '<meta http-equiv=refresh content=0;url=rust-docs/index.html>' > target/doc/index.html
          mkdir -p build/docs/rust-docs
          cp -rf target/doc/* build/docs/rust-docs
          
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: build/docs # The folder the action should deploy.
